<html>
	<head>
		<title>My ParseApp site</title>
		<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.2.min.js"></script>
		<script type="text/javascript">
			var appId = 'shB8up4c14Idr6eFH4SBjzqZ1vdYT0Q79LSaPQwT';
			var jsKey = 'PQrHeggtLnjUfFh4KI1IV5vLhZXztUzfdlUnk5X2';

			Parse.initialize(appId, jsKey);
			// This identifies your website in the createToken call below
			Stripe.setPublishableKey('pk_test_EMIAzyTdHHJaFEnWTNchuOTZ');
			var stripeResponseHandler = function(status, response) {
				var $form = $('#payment-form');

				if (response.error) {
					// Show the errors on the form
					$form.find('.payment-errors').text(response.error.message);
					$form.find('button').prop('disabled', false);
				} else {
					// token contains id, last4, and card type
					var token = response.id;

					var Payment = Parse.Object.extend('Payment');
					var payment = new Payment();
					payment.set('name', 'eugene');
					payment.set('stripeToken', token);
					payment.save(null, {
						success : function(payment) {
							alert('New object created with objectId: ' + payment.id);
						},
						error : function(payment, error) {
							alert('Failed to create new object, with error code: ' + error.message);
						}
					});
					Parse.Cloud.run('pay', { amount:1000,
						                     stripeToken:token
						                    },{
						success : function(amount) {
							alert('Success: ' + amount);
						},
						error : function(error) {
							console.log(error);
						}
					});
					// $.put('https://'+appId+':javascript-key'+jsKey+='@api.parse.com/1/classes/User/eugene', user, function(response){
					// console.log(response);
					// });
					// Insert the token into the form so it gets submitted to the server
					//$form.append($('<input type="hidden" name="stripeToken" />').val(token));
					// and re-submit
					//$form.get(0).submit();
				}
			};

			jQuery(function($) {
				$('#payment-form').submit(function(e) {
					var $form = $(this);

					// Disable the submit button to prevent repeated clicks
					$form.find('button').prop('disabled', true);

					Stripe.card.createToken($form, stripeResponseHandler);
					
					// Prevent the form from submitting with the default action
					return false;
				});
			});
		</script>
	</head>
	<body>
		<div>
			<form action="" method="POST" id="payment-form">
				<span class="payment-errors"></span>

				<div class="form-row">
					<label> <span>Card Number</span>
						<input type="text" size="20" data-stripe="number" value="4242424242424242"/>
					</label>
				</div>

				<div class="form-row">
					<label><span>CVC</span>
						<input type="text" size="4" data-stripe="cvc" value="123"/>
					</label>
				</div>

				<div class="form-row">
					<label> <span>Expiration (MM/YYYY)</span>
						<input type="text" size="2" data-stripe="exp-month" value="12"/>
					</label>
					<span> / </span>
					<input type="text" size="4" data-stripe="exp-year" value="2015"/>
				</div>
				<button type="submit">
					Submit Payment
				</button>
			</form>
		</div>
	</body>
</html>
